<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 å¥‡ç¾æœˆ | é†«å­¸äººæ–‡æ²™é¾å„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Noto+Serif+TC:wght@400;600;700&family=Lato:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sage: {
                            50: '#f4f7f4',
                            100: '#e3ebe3',
                            200: '#c5d6c5',
                            300: '#9bb69b',
                            400: '#749474',
                            500: '#567656',
                            600: '#425e42',
                            700: '#364b36',
                            800: '#2d3d2d',
                            900: '#263226',
                        },
                        gold: {
                            400: '#fbbf24',
                            500: '#f59e0b',
                        },
                        cream: '#FDFBF7',
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', '"Noto Serif TC"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FDFBF7;
            color: #2d3d2d;
            background-image: radial-gradient(#9bb69b 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(86, 118, 86, 0.08);
            border: 1px solid #e3ebe3;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #9bb69b, #567656);
        }

        /* Sticky Notes */
        .sticky-note {
            transition: transform 0.2s;
            box-shadow: 2px 4px 8px rgba(0,0,0,0.1);
            font-family: 'Noto Serif TC', serif;
        }
        .sticky-note:hover {
            transform: scale(1.05) rotate(0deg) !important;
            z-index: 10;
            box-shadow: 4px 8px 16px rgba(0,0,0,0.15);
        }
        .note-color-1 { background-color: #fff7ed; border-left: 4px solid #fdba74; transform: rotate(-1deg); }
        .note-color-2 { background-color: #f0fdf4; border-left: 4px solid #86efac; transform: rotate(1deg); }
        .note-color-3 { background-color: #eff6ff; border-left: 4px solid #93c5fd; transform: rotate(-1.5deg); }
        .note-color-4 { background-color: #fdf4ff; border-left: 4px solid #f0abfc; transform: rotate(1.5deg); }

        /* Session List Styling */
        .session-item {
            border-bottom: 1px dashed #e3ebe3;
            padding: 12px 0;
        }
        .session-item:last-child {
            border-bottom: none;
        }
        .session-time {
            color: #567656;
            font-weight: 700;
            font-family: 'Lato', sans-serif;
            min-width: 50px;
        }

        /* Hide default checkbox but keep logic */
        .hidden-control {
            display: none;
        }
    </style>
</head>
<body class="p-6 md:p-10 min-h-screen flex flex-col items-center">

    <!-- Header -->
    <header class="w-full max-w-7xl mb-8 flex flex-col md:flex-row justify-between items-end border-b-2 border-sage-200 pb-6">
        <div>
            <h1 class="text-3xl md:text-4xl font-serif text-sage-800 font-bold flex items-center gap-3">
                <i class="fa-solid fa-leaf text-sage-400"></i>
                2025 å¥‡ç¾æœˆï½œé†«å­¸äººæ–‡æ²™é¾æˆæ•ˆåˆ†æå„€è¡¨æ¿
            </h1>
            <p class="text-sage-600 mt-3 font-sans text-lg tracking-wide font-medium">
                é†«å­¸äººæ–‡æ²™é¾ Ã— AMEEç¾åœ°è¶¨å‹¢ Ã— å¾®å‹æ·±åº¦äº¤æµ
            </p>
        </div>
        
        <!-- Hidden Control Logic (Auto-connects) -->
        <input type="checkbox" id="use-real-data" class="hidden-control" checked>
    </header>

    <main class="w-full max-w-7xl grid grid-cols-1 md:grid-cols-12 gap-6">

        <!-- KPI Cards (Row 1) -->
        <div class="col-span-12 grid grid-cols-1 md:grid-cols-4 gap-6 mb-2">
            <!-- Total Responses (Questionnaire) -->
            <div class="card p-6 bg-white">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sage-400 text-sm font-bold uppercase">å•å·å›è¦†æ•¸</p>
                        <h3 class="text-4xl font-serif text-sage-800 mt-2" id="total-responses">0</h3>
                    </div>
                    <div class="bg-sage-100 p-3 rounded-full text-sage-600">
                        <i class="fa-solid fa-clipboard-list text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Attendance (Fixed) -->
            <div class="card p-6 bg-white">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sage-400 text-sm font-bold uppercase">æ²™é¾ç¸½å‡ºå¸­äººæ¬¡</p>
                        <h3 class="text-4xl font-serif text-sage-800 mt-2">140</h3>
                    </div>
                    <div class="bg-sage-100 p-3 rounded-full text-sage-600">
                        <i class="fa-solid fa-users text-xl"></i>
                    </div>
                </div>
                <p class="text-xs text-sage-400 mt-2">9å ´æ¬¡ç¸½è¨ˆ</p>
            </div>

            <!-- Overall Satisfaction -->
            <div class="card p-6 bg-white">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sage-400 text-sm font-bold uppercase">æ•´é«”æ»¿æ„åº¦</p>
                        <h3 class="text-4xl font-serif text-sage-800 mt-2" id="avg-satisfaction">0.0</h3>
                    </div>
                    <div class="bg-sage-100 p-3 rounded-full text-sage-600">
                        <i class="fa-solid fa-heart text-xl"></i>
                    </div>
                </div>
                <p class="text-xs text-sage-400 mt-2">æ»¿åˆ† 5.0</p>
            </div>

            <!-- Recommendation (SAT 6) -->
            <div class="card p-6 bg-white">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sage-400 text-sm font-bold uppercase">æ¨è–¦æ„é¡˜</p>
                        <h3 class="text-4xl font-serif text-sage-800 mt-2" id="avg-recommend">0.0</h3>
                    </div>
                    <div class="bg-sage-100 p-3 rounded-full text-sage-600">
                        <i class="fa-solid fa-thumbs-up text-xl"></i>
                    </div>
                </div>
                <p class="text-xs text-sage-400 mt-2">æ»¿åˆ† 10.0</p>
            </div>
        </div>

        <!-- Session Info (New Section) -->
        <div class="col-span-12 card p-6 bg-white mb-2">
            <h3 class="text-xl font-serif text-sage-800 mb-4 border-b border-sage-100 pb-2">
                <i class="fa-solid fa-calendar-day mr-2 text-sage-500"></i> 
                å ´æ¬¡ä¸»é¡Œèˆ‡å‡ºå¸­æ¦‚æ³
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <!-- Morning -->
                <div>
                    <h4 class="text-sage-600 font-bold mb-3 flex items-center text-lg"><i class="fa-regular fa-sun mr-2"></i>ä¸Šåˆå ´æ¬¡</h4>
                    <ul class="text-sm text-sage-800 space-y-1">
                        <li class="session-item">
                            <div class="flex gap-3 mb-1">
                                <span class="session-time">10:00</span>
                                <span class="font-bold text-sage-900">Moral, Ethical and Legal Issues of AI in HPE</span>
                            </div>
                            <div class="flex justify-between items-center pl-[62px]">
                                <span class="text-sage-600">å¥‡åº·è¨ºæ‰€ å¼µæ¦®å“²ä¸»ä»»</span>
                                <span class="font-bold bg-sage-50 px-2 py-0.5 rounded text-sage-700 text-xs">11äºº</span>
                            </div>
                        </li>
                        <li class="session-item">
                            <div class="flex gap-3 mb-1">
                                <span class="session-time">10:30</span>
                                <span class="font-bold text-sage-900">Profession Identity Formation and AI</span>
                            </div>
                            <div class="flex justify-between items-center pl-[62px]">
                                <span class="text-sage-600">è­·ç†éƒ¨ æ±Ÿæƒ è‹±å‰¯éƒ¨é•·</span>
                                <span class="font-bold bg-sage-50 px-2 py-0.5 rounded text-sage-700 text-xs">19äºº</span>
                            </div>
                        </li>
                        <li class="session-item">
                            <div class="flex gap-3 mb-1">
                                <span class="session-time">11:00</span>
                                <span class="font-bold text-sage-900">Learning from Errors, Teaching with Empathy</span>
                            </div>
                            <div class="flex justify-between items-center pl-[62px]">
                                <span class="text-sage-600">è—¥åŠ‘éƒ¨ è˜‡æ…§çœŸéƒ¨é•·</span>
                                <span class="font-bold bg-sage-50 px-2 py-0.5 rounded text-sage-700 text-xs">19äºº</span>
                            </div>
                        </li>
                        <li class="session-item">
                            <div class="flex gap-3 mb-1">
                                <span class="session-time">11:30</span>
                                <span class="font-bold text-sage-900">æ­¡è¿ä¾†åˆ°æˆ‘çš„ AMEE ç§€</span>
                            </div>
                            <div class="flex justify-between items-center pl-[62px]">
                                <span class="text-sage-600">æ•™å­¸éƒ¨ æ—æ±¶ç§€æ•™å­¸è¡Œæ”¿ç®¡ç†å“¡</span>
                                <span class="font-bold bg-sage-50 px-2 py-0.5 rounded text-sage-700 text-xs">13äºº</span>
                            </div>
                        </li>
                    </ul>
                </div>
                <!-- Afternoon -->
                <div>
                    <h4 class="text-sage-600 font-bold mb-3 flex items-center text-lg"><i class="fa-solid fa-mug-hot mr-2"></i>ä¸‹åˆå ´æ¬¡</h4>
                    <ul class="text-sm text-sage-800 space-y-1">
                        <li class="session-item">
                            <div class="flex gap-3 mb-1">
                                <span class="session-time">13:30</span>
                                <span class="font-bold text-sage-900">æ€¡èµ·å‡ºç™¼çš„ AMEE ä¹‹æ—…</span>
                            </div>
                            <div class="flex justify-between items-center pl-[62px]">
                                <span class="text-sage-600">æ•™å­¸éƒ¨ è¨±æ·‘æ€¡æ•™å­¸è¡Œæ”¿ç®¡ç†å“¡</span>
                                <span class="font-bold bg-sage-50 px-2 py-0.5 rounded text-sage-700 text-xs">15äºº</span>
                            </div>
                        </li>
                        <li class="session-item">
                            <div class="flex gap-3 mb-1">
                                <span class="session-time">14:00</span>
                                <span class="font-bold text-sage-900">A å’ªå©·ã€çœ‹ã€è½</span>
                            </div>
                            <div class="flex justify-between items-center pl-[62px]">
                                <span class="text-sage-600">æ•™å­¸éƒ¨ æ¥Šå®œå©·æ•™å­¸è¡Œæ”¿ç®¡ç†å“¡</span>
                                <span class="font-bold bg-sage-50 px-2 py-0.5 rounded text-sage-700 text-xs">18äºº</span>
                            </div>
                        </li>
                        <li class="session-item">
                            <div class="flex gap-3 mb-1">
                                <span class="session-time">14:30</span>
                                <span class="font-bold text-sage-900">AMEE æ°£è±¡å°: ä¸‹ä¸€æ³¢æ•™å­¸ã€äº‘ã€åœ–è®ŠåŒ–</span>
                            </div>
                            <div class="flex justify-between items-center pl-[62px]">
                                <span class="text-sage-600">æ•™å­¸éƒ¨ ç›§è‹±äº‘æ•™å­¸è¡Œæ”¿ç®¡ç†å“¡</span>
                                <span class="font-bold bg-sage-50 px-2 py-0.5 rounded text-sage-700 text-xs">16äºº</span>
                            </div>
                        </li>
                        <li class="session-item">
                            <div class="flex gap-3 mb-1">
                                <span class="session-time">15:00</span>
                                <span class="font-bold text-sage-900">è©©è—ç›¸èï¼ŒèŠ¸æ€ç¶»æ”¾â€”ä¾†è‡ª AMEE çš„æ–°å•Ÿç™¼</span>
                            </div>
                            <div class="flex justify-between items-center pl-[62px]">
                                <span class="text-sage-600">æ•™å­¸éƒ¨ é™³è©©èŠ¸æ•™å­¸è¡Œæ”¿ç®¡ç†å“¡</span>
                                <span class="font-bold bg-sage-50 px-2 py-0.5 rounded text-sage-700 text-xs">17äºº</span>
                            </div>
                        </li>
                        <li class="session-item">
                            <div class="flex gap-3 mb-1">
                                <span class="session-time">15:30</span>
                                <span class="font-bold text-sage-900">å­¸ç¿’çš„é›…è¶£: åœ¨ AMEE æ‰¾å›æ¢ç´¢çš„åˆå¿ƒ</span>
                            </div>
                            <div class="flex justify-between items-center pl-[62px]">
                                <span class="text-sage-600">æ•™å­¸éƒ¨ æ—æ·‘é›…æ•™å­¸è¡Œæ”¿ç®¡ç†å“¡</span>
                                <span class="font-bold bg-sage-50 px-2 py-0.5 rounded text-sage-700 text-xs">12äºº</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Demographics -->
        <div class="col-span-12 grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Role -->
            <div class="card p-6">
                <h3 class="text-xl font-serif text-sage-800 mb-4 border-b border-sage-100 pb-2">
                    <i class="fa-solid fa-user-md mr-2 text-sage-500"></i> å­¸å“¡è·ä½åˆ†ä½ˆ
                </h3>
                <div class="h-64 w-full flex justify-center">
                    <canvas id="roleChart"></canvas>
                </div>
            </div>
            <!-- Years -->
            <div class="card p-6">
                <h3 class="text-xl font-serif text-sage-800 mb-4 border-b border-sage-100 pb-2">
                    <i class="fa-solid fa-clock-rotate-left mr-2 text-sage-500"></i> å­¸å“¡å¹´è³‡åˆ†ä½ˆ
                </h3>
                <div class="h-64 w-full">
                    <canvas id="yearsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Learning Analysis (Post 1-11) -->
        <div class="col-span-12 card p-6">
            <h3 class="text-xl font-serif text-sage-800 mb-6 border-b border-sage-100 pb-2">
                <i class="fa-brands fa-leanpub mr-2 text-sage-500"></i> 
                å¾Œæ¸¬å­¸ç¿’æˆæœèˆ‡æˆæ•ˆåˆ†æ (Post-test)
            </h3>
            <div class="h-80 w-full">
                <canvas id="learningChart"></canvas>
            </div>
        </div>

        <!-- Satisfaction Details -->
        <div class="col-span-12 card p-6">
            <h3 class="text-xl font-serif text-sage-800 mb-4 border-b border-sage-100 pb-2">
                <i class="fa-regular fa-face-smile mr-2 text-sage-500"></i>
                æ´»å‹•æ»¿æ„åº¦ç´°é … (1-5åˆ†)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6" id="satisfaction-bars">
                <!-- Bars generated by JS -->
            </div>
        </div>

        <!-- Sticky Notes (Qualitative) -->
        <div class="col-span-12">
            <h3 class="text-2xl font-serif text-sage-800 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-quote-left text-sage-500"></i>
                å­¸å“¡æœ€æœ‰æ„Ÿæ”¶ç©«
            </h3>
            <div class="flex flex-wrap gap-6 justify-center md:justify-start" id="feedback-grid">
                <!-- Sticky Notes generated by JS -->
            </div>
        </div>

    </main>

    <footer class="w-full text-center py-10 text-sage-400 text-sm">
        <p>2025 å¥‡ç¾æœˆï½œé†«å­¸äººæ–‡æ²™é¾</p>
    </footer>

    <script>
        // CONFIG: æ‚¨çš„ Apps Script ç¶²å€
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwDoTNot1XRvyJLH9jktiKo5KhdR0mLv0oD-vX0JDvdTZXUHZ3u_LnlFL6fB6C-Jd-IIw/exec"; 
        
        // Mock Data (Fallback)
        function generateMockData() {
            const count = 30;
            const data = [];
            const comments = [
                "è¬›è€…å°æ–¼é†«å­¸äººæ–‡çš„è©®é‡‹éå¸¸æ·±åˆ»ã€‚",
                "PBL çš„å¸¶é ˜æŠ€å·§ç¤ºç¯„å¾ˆå¯¦ç”¨ã€‚",
                "SDT ç†è«–èˆ‡å¯¦å‹™çš„çµåˆè®“æˆ‘å¤§é–‹çœ¼ç•Œã€‚",
                "éå¸¸æœ‰è³ªæ„Ÿçš„æ²™é¾ï¼Œç’°å¢ƒå’Œå…§å®¹éƒ½å¾ˆç™‚ç™’ã€‚",
                "äº’å‹•ç’°ç¯€è¨­è¨ˆå¾—å¾ˆæ£’ã€‚",
                "å­¸åˆ°äº†å¦‚ä½•ç”¨æ›´æœ‰æº«åº¦çš„æ–¹å¼å»å¼•å°å­¸ç”Ÿã€‚",
                "å°æ–¼åæ€æ•™å­¸æœ‰äº†æ›´å…·é«”çš„æ¶æ§‹èªè­˜ã€‚"
            ];
            const roles = ["ä¸»æ²»é†«å¸«", "ä½é™¢é†«å¸«", "è­·ç†å¸«", "é†«å­¸ç”Ÿ", "å…¶ä»–"];
            const years = ["1å¹´ä»¥ä¸‹", "1-5å¹´", "6-10å¹´", "10å¹´ä»¥ä¸Š"];

            for (let i = 0; i < count; i++) {
                data.push({
                    role: roles[Math.floor(Math.random() * roles.length)],
                    years: years[Math.floor(Math.random() * years.length)],
                    post_1: Math.random() * 1 + 4, post_2: Math.random() * 1 + 3.5, // Mock float
                    post_3: Math.random() * 1 + 4, post_4: Math.random() * 1.5 + 3,
                    post_5: 5, post_6: 4.5, post_7: 4.2, post_8: 4.8,
                    post_9: 4.5, post_10: 5, post_11: 4.3,
                    open_post_1: comments[Math.floor(Math.random() * comments.length)],
                    sat_1: 5, sat_2: 4, sat_3: 4, sat_4: 5, sat_5: 5, 
                    sat_6: Math.floor(Math.random() * 3) + 8, // Sat 6 is Rec (1-10)
                    open_sat_1: "ä¸éŒ¯"
                });
            }
            return data;
        }

        let chartInstances = {};

        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('use-real-data');
            // Auto fetch immediately
            fetchData();
        });

        function setMockMode() {
            console.log("Using mock data");
            updateDashboard(generateMockData());
        }

        async function fetchData() {
            try {
                const response = await fetch(GAS_API_URL);
                const json = await response.json();
                if (json.error) throw new Error(json.error);
                
                if (json.length === 0) {
                    console.log("Connected but no data.");
                    updateDashboard([]);
                } else {
                    updateDashboard(json);
                }
            } catch (error) {
                console.error("Fetch error, falling back to mock:", error);
                setMockMode();
            }
        }

        function parseScore(val) {
            if (!val) return 0;
            const p = parseFloat(val);
            return isNaN(p) ? 0 : p;
        }

        function calculateAverage(data, key) {
            if (!data || data.length === 0) return 0;
            const sum = data.reduce((acc, curr) => acc + parseScore(curr[key]), 0);
            return (sum / data.length).toFixed(1); // keep 1 decimal
        }

        function updateDashboard(data) {
            const count = data.length;
            document.getElementById('total-responses').innerText = count;

            if (count === 0) {
                document.getElementById('avg-satisfaction').innerText = "0.0";
                document.getElementById('avg-recommend').innerText = "0.0";
                document.getElementById('feedback-grid').innerHTML = '<p class="text-sage-400 w-full text-center">å°šç„¡æ•¸æ“š</p>';
                document.getElementById('satisfaction-bars').innerHTML = '';
                if(chartInstances.learning) chartInstances.learning.destroy();
                if(chartInstances.role) chartInstances.role.destroy();
                if(chartInstances.years) chartInstances.years.destroy();
                return;
            }

            // KPI Cards
            document.getElementById('avg-satisfaction').innerText = calculateAverage(data, 'sat_1');
            // Sat 6 is Recommendation (1-10 scale)
            document.getElementById('avg-recommend').innerText = calculateAverage(data, 'sat_6'); 

            // Charts
            updateDemographics(data);
            updateLearningChart(data);
            updateSatBars(data);
            updateStickyNotes(data);
        }

        function updateDemographics(data) {
            // Role
            const roleCounts = {};
            data.forEach(d => { const r = d.role || "æœªå¡«å¯«"; roleCounts[r] = (roleCounts[r] || 0) + 1; });
            const ctxRole = document.getElementById('roleChart').getContext('2d');
            if (chartInstances.role) chartInstances.role.destroy();
            chartInstances.role = new Chart(ctxRole, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(roleCounts),
                    datasets: [{
                        data: Object.values(roleCounts),
                        backgroundColor: ['#749474', '#9bb69b', '#c5d6c5', '#e3ebe3', '#567656'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'right' } } }
            });

            // Years
            const yearCounts = {};
            data.forEach(d => { const y = d.years || "æœªå¡«å¯«"; yearCounts[y] = (yearCounts[y] || 0) + 1; });
            const ctxYears = document.getElementById('yearsChart').getContext('2d');
            if (chartInstances.years) chartInstances.years.destroy();
            chartInstances.years = new Chart(ctxYears, {
                type: 'bar',
                data: {
                    labels: Object.keys(yearCounts),
                    datasets: [{
                        label: 'äººæ•¸',
                        data: Object.values(yearCounts),
                        backgroundColor: '#9bb69b',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateLearningChart(data) {
            const ctx = document.getElementById('learningChart').getContext('2d');
            // 1. Define raw Data mapping
            const rawLabels = [
                'é†«å­¸äººæ–‡ç†è§£', 'PBLæŠ€å·§', 'åæ€å¼•å°', 'Kolbé‹ç”¨', 'SDTç†è§£', 
                'æ•™å­¸è‡ªä¸»æ€§', 'å‹ä»»æ„Ÿ', 'é—œä¿‚æ„Ÿ', 
                'ç²å¾—å…·é«”ç¶“é©—', 'é€²è¡Œåæ€è§€å¯Ÿ', 'æ”¹å–„æ•™å­¸æ–‡åŒ–'
            ];
            const keys = [
                'post_1', 'post_2', 'post_3', 'post_4', 'post_5', 
                'post_6', 'post_7', 'post_8', 
                'post_9', 'post_10', 'post_11'
            ];
            
            // 2. Calculate values and create an array of objects to sort
            let combinedData = keys.map((key, index) => {
                return {
                    label: rawLabels[index],
                    value: parseFloat(calculateAverage(data, key)) // ensure number for sorting
                };
            });

            // 3. Sort descending by value
            combinedData.sort((a, b) => b.value - a.value);

            // 4. Extract sorted arrays
            const sortedLabels = combinedData.map(d => d.label);
            const sortedValues = combinedData.map(d => d.value);

            // 5. Find max value for Highlight logic
            const maxVal = sortedValues[0]; // since sorted descending, first is max
            
            // 6. Create Colors and formatted Labels with Icon
            const backgroundColors = sortedValues.map(v => v === maxVal ? '#f59e0b' : '#9bb69b'); // Gold for max
            const finalLabels = sortedLabels.map((l, i) => sortedValues[i] === maxVal ? l + ' ğŸ†' : l);

            // 7. Determine Y-axis scale (Dynamic zoom)
            const minVal = Math.min(...sortedValues);
            // Start scale at (lowest value - 0.5) but not below 0, to show contrast
            const scaleMin = Math.max(0, Math.floor(minVal - 0.5));

            if (chartInstances.learning) chartInstances.learning.destroy();
            
            chartInstances.learning = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: finalLabels,
                    datasets: [{
                        label: 'å¹³å‡åˆ†',
                        data: sortedValues,
                        backgroundColor: backgroundColors,
                        borderRadius: 6,
                        barThickness: 25
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            min: scaleMin, // Dynamic scale
                            max: 5, 
                            grid: { color: '#e3ebe3' } 
                        }, 
                        x: { grid: { display: false } } 
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateSatBars(data) {
            const container = document.getElementById('satisfaction-bars');
            container.innerHTML = '';
            // Sat 1 is Overall, Sat 6 is Rec (1-10). 
            // Showing details 2-5 (1-5 scale)
            const metrics = [
                { l: 'è¬›è€…å‘ˆç¾', k: 'sat_2' },
                { l: 'æ™‚é–“å®‰æ’', k: 'sat_3' },
                { l: 'åæ€ç©ºé–“', k: 'sat_4' },
                { l: 'ç¬¦åˆæœŸå¾…', k: 'sat_5' }
            ];

            metrics.forEach(m => {
                const avg = calculateAverage(data, m.k);
                const pct = (avg / 5) * 100;
                container.insertAdjacentHTML('beforeend', `
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium text-sage-700">${m.l}</span>
                            <span class="text-sm font-bold text-sage-600">${avg}</span>
                        </div>
                        <div class="w-full bg-sage-100 rounded-full h-2.5">
                            <div class="bg-sage-500 h-2.5 rounded-full" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `);
            });
        }

        function updateStickyNotes(data) {
            const container = document.getElementById('feedback-grid');
            container.innerHTML = '';
            
            // Use open_post_1
            const comments = data.map(d => d.open_post_1).filter(c => c && c.toString().trim() !== "").reverse();

            if (comments.length === 0) {
                container.innerHTML = '<p class="text-sage-400 w-full text-center">å°šç„¡æ–‡å­—å›é¥‹</p>';
                return;
            }

            comments.slice(0, 20).forEach((c, i) => {
                const colorClass = `note-color-${(i % 4) + 1}`;
                container.insertAdjacentHTML('beforeend', `
                    <div class="sticky-note ${colorClass} p-5 rounded-sm w-full md:w-64 min-h-[160px] flex flex-col relative">
                        <i class="fa-solid fa-thumbtack text-sage-800/20 absolute top-2 left-1/2 -translate-x-1/2"></i>
                        <div class="mt-4 flex-grow flex items-center justify-center text-center">
                            <p class="text-sage-900 text-sm font-serif leading-relaxed">"${c}"</p>
                        </div>
                    </div>
                `);
            });
        }
    </script>
</body>
</html>
