<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 å¥‡ç¾æœˆ | é†«å­¸äººæ–‡æ²™é¾æˆæ•ˆåˆ†æå„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.6/dist/jstat.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Noto+Serif+TC:wght@400;600;700&family=Lato:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sage: {
                            50: '#f4f7f4', 100: '#e3ebe3', 200: '#c5d6c5', 300: '#9bb69b',
                            400: '#749474', 500: '#567656', 600: '#425e42', 700: '#364b36',
                            800: '#2d3d2d', 900: '#263226',
                        },
                        gold: { 400: '#fbbf24', 500: '#f59e0b' }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', '"Noto Serif TC"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FDFBF7;
            color: #2d3d2d;
            background-image: radial-gradient(#9bb69b 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(86, 118, 86, 0.08);
            border: 1px solid #e3ebe3;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card:hover { transform: translateY(-5px); }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, #9bb69b, #567656);
        }
        .sticky-note {
            transition: transform 0.2s; box-shadow: 2px 4px 8px rgba(0,0,0,0.1);
            font-family: 'Noto Serif TC', serif;
        }
        .sticky-note:hover {
            transform: scale(1.05) rotate(0deg) !important; z-index: 10;
            box-shadow: 4px 8px 16px rgba(0,0,0,0.15);
        }
        .note-color-1 { background-color: #fff7ed; border-left: 4px solid #fdba74; transform: rotate(-1deg); }
        .note-color-2 { background-color: #f0fdf4; border-left: 4px solid #86efac; transform: rotate(1deg); }
        .note-color-3 { background-color: #eff6ff; border-left: 4px solid #93c5fd; transform: rotate(-1.5deg); }
        .note-color-4 { background-color: #fdf4ff; border-left: 4px solid #f0abfc; transform: rotate(1.5deg); }
        
        .pdca-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .pdca-box { padding: 16px; border-radius: 12px; position: relative; }
        .pdca-box h4 { font-weight: 800; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .pdca-box p { font-size: 0.9rem; line-height: 1.6; }
        .pdca-plan { background-color: #fffbeb; color: #92400e; border: 1px solid #fcd34d; }
        .pdca-do { background-color: #eff6ff; color: #1e40af; border: 1px solid #93c5fd; }
        .pdca-check { background-color: #f0fdf4; color: #166534; border: 1px solid #86efac; }
        .pdca-act { background-color: #faf5ff; color: #6b21a8; border: 1px solid #d8b4fe; }
        
        /* Status Badge */
        .status-badge {
            font-size: 0.85rem; padding: 4px 12px; border-radius: 99px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .status-live { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .status-mock { background-color: #ffedd5; color: #9a3412; border: 1px solid #fdba74; }
        .hidden-control { display: none; }
    </style>
</head>
<body class="p-6 md:p-10 min-h-screen flex flex-col items-center">

    <header class="w-full max-w-7xl mb-8 flex flex-col md:flex-row justify-between items-end border-b-2 border-sage-200 pb-6">
        <div>
            <h1 class="text-3xl md:text-4xl font-serif text-sage-800 font-bold flex items-center gap-3">
                <i class="fa-solid fa-leaf text-sage-400"></i>
                2025 å¥‡ç¾æœˆï½œé†«å­¸äººæ–‡æ²™é¾æˆæ•ˆåˆ†æå„€è¡¨æ¿
            </h1>
            <div class="flex flex-wrap items-center gap-4 mt-3">
                <p class="text-sage-600 font-sans text-lg tracking-wide font-medium">
                    é©…å‹•å› å­åˆ†æ Ã— ç†è«–æ§‹é¢é©—è­‰ Ã— æ·±åº¦æ´å¯Ÿ
                </p>
                <!-- Data Source Status Indicator -->
                <div id="data-status" class="status-badge bg-gray-100 text-gray-500 border-gray-200">
                    <i class="fa-solid fa-spinner fa-spin"></i> è³‡æ–™é€£ç·šä¸­...
                </div>
            </div>
        </div>
        <input type="checkbox" id="use-real-data" class="hidden-control" checked>
    </header>

    <main class="w-full max-w-7xl grid grid-cols-1 md:grid-cols-12 gap-6">

        <!-- KPI Cards -->
        <div class="col-span-12 grid grid-cols-1 md:grid-cols-5 gap-6 mb-2">
            <div class="card p-6 bg-white">
                <div class="flex justify-between items-start">
                    <div><p class="text-sage-400 text-xs font-bold uppercase">æœ‰æ•ˆå•å·å›æ”¶ (N)</p><h3 class="text-3xl font-serif text-sage-800 mt-2" id="total-responses">0</h3></div>
                    <div class="bg-sage-100 p-2 rounded-full text-sage-600"><i class="fa-solid fa-file-signature"></i></div>
                </div>
            </div>
            <div class="card p-6 bg-white border-l-4 border-sage-500">
                <div class="flex justify-between items-start">
                    <div><p class="text-sage-400 text-xs font-bold uppercase">æ²™é¾ç¸½å‡ºå¸­äººæ¬¡</p><h3 class="text-3xl font-serif text-sage-800 mt-2">140</h3></div>
                    <div class="bg-sage-100 p-2 rounded-full text-sage-600"><i class="fa-solid fa-users"></i></div>
                </div>
                <p class="text-[10px] text-sage-400 mt-2">9å ´æ¬¡ç¸½è¨ˆ</p>
            </div>
            <div class="card p-6 bg-white">
                <div class="flex justify-between items-start">
                    <div><p class="text-sage-400 text-xs font-bold uppercase">ä¿¡åº¦ (Cronbach's Î±)</p><h3 class="text-3xl font-serif text-sage-800 mt-2" id="cronbach-alpha">0.00</h3></div>
                    <div class="bg-sage-100 p-2 rounded-full text-sage-600"><i class="fa-solid fa-check-double"></i></div>
                </div>
                <p class="text-[10px] text-sage-400 mt-2" id="alpha-interpretation">è¨ˆç®—ä¸­...</p>
            </div>
            <div class="card p-6 bg-white">
                <div class="flex justify-between items-start">
                    <div><p class="text-sage-400 text-xs font-bold uppercase">æ•´é«”æ»¿æ„åº¦</p><h3 class="text-3xl font-serif text-sage-800 mt-2" id="avg-satisfaction">0.0</h3></div>
                    <div class="bg-sage-100 p-2 rounded-full text-sage-600"><i class="fa-solid fa-heart"></i></div>
                </div>
                <p class="text-[10px] text-sage-400 mt-2">æ»¿åˆ† 5.0</p>
            </div>
            <div class="card p-6 bg-white">
                <div class="flex justify-between items-start">
                    <div><p class="text-sage-400 text-xs font-bold uppercase">æ·¨æ¨è–¦å€¼ (NPS)</p><h3 class="text-3xl font-serif text-sage-800 mt-2" id="avg-recommend">0.0</h3></div>
                    <div class="bg-sage-100 p-2 rounded-full text-sage-600"><i class="fa-solid fa-thumbs-up"></i></div>
                </div>
                <p class="text-[10px] text-sage-400 mt-2">æ»¿åˆ† 10.0</p>
            </div>
        </div>

        <!-- Key Driver & SDT Charts -->
        <div class="col-span-12 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card p-6">
                <h3 class="text-xl font-serif text-sage-800 mb-4 border-b border-sage-100 pb-2">
                    <i class="fa-solid fa-key mr-2 text-gold-500"></i>
                    NPS é—œéµé©…å‹•å› å­ (Key Drivers)
                </h3>
                <p class="text-xs text-sage-500 mb-2">å“ªäº›é …ç›®èˆ‡ã€Œæ¨è–¦æ„é¡˜ã€ç›¸é—œæ€§æœ€é«˜ï¼Ÿ(é¡¯ç¤ºå‰ 5 é …)</p>
                <div class="h-64 w-full">
                    <canvas id="driverChart"></canvas>
                </div>
            </div>
            <div class="card p-6">
                <h3 class="text-xl font-serif text-sage-800 mb-4 border-b border-sage-100 pb-2">
                    <i class="fa-solid fa-bullseye mr-2 text-sage-500"></i>
                    SDT è‡ªæˆ‘æ±ºå®šè«–æ§‹é¢åˆ†æ
                </h3>
                <div class="h-64 w-full flex justify-center">
                    <canvas id="sdtChart"></canvas>
                </div>
            </div>
        </div>

        <!-- NEW: Deep Dive Insights for Driver & SDT -->
        <div class="col-span-12 card p-6 bg-sage-50 border-l-4 border-gold-400">
            <h3 class="text-xl font-serif text-sage-800 mb-4 flex items-center">
                <i class="fa-solid fa-magnifying-glass-chart mr-2 text-sage-600"></i>
                é—œéµé©…å‹•èˆ‡å¿ƒç†éœ€æ±‚æ·±åº¦è§£æ (Correlation & Construct Insights)
            </h3>
            <div id="driver-sdt-insights" class="text-sm md:text-base text-sage-800 space-y-3 leading-relaxed">
                <!-- JS Will Populate This -->
                è¼‰å…¥åˆ†æä¸­...
            </div>
        </div>

        <!-- Demographics -->
        <div class="col-span-12 md:col-span-6 card p-6">
             <h3 class="text-xl font-serif text-sage-800 mb-4 border-b border-sage-100 pb-2">
                <i class="fa-solid fa-id-card-clip mr-2 text-sage-500"></i> 
                æ¨£æœ¬çµæ§‹ (Demographics)
            </h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="h-48 w-full flex justify-center"><canvas id="roleChart"></canvas></div>
                <div class="h-48 w-full"><canvas id="yearsChart"></canvas></div>
            </div>
        </div>
        
        <!-- Role/Year Insights -->
        <div class="col-span-12 md:col-span-6 flex flex-col gap-4">
             <div class="card p-6 flex-grow bg-gradient-to-br from-white to-sage-50">
                <h3 class="text-xl font-serif text-sage-800 mb-3 flex items-center"><i class="fa-solid fa-user-doctor mr-2 text-sage-600"></i> è·ä½æ´å¯Ÿ (Role Insights)</h3>
                <div id="role-insights" class="text-sm text-sage-800 space-y-2 leading-relaxed">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="card p-6 flex-grow bg-gradient-to-br from-white to-sage-50">
                <h3 class="text-xl font-serif text-sage-800 mb-3 flex items-center"><i class="fa-solid fa-hourglass-half mr-2 text-sage-600"></i> å¹´è³‡æ´å¯Ÿ (Years Insights)</h3>
                <div id="year-insights" class="text-sm text-sage-800 space-y-2 leading-relaxed">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- Post-test Analysis -->
        <div class="col-span-12 card p-6">
            <h3 class="text-xl font-serif text-sage-800 mb-6 border-b border-sage-100 pb-2 flex flex-wrap justify-between items-center gap-4">
                <span><i class="fa-brands fa-leanpub mr-2 text-sage-500"></i> å¾Œæ¸¬å­¸ç¿’æˆæœ (Post-test Analysis)</span>
                <div class="flex items-center gap-3 text-xs md:text-sm"><span class="flex items-center text-sage-500"><i class="fa-solid fa-circle-info mr-1"></i> æç¤ºï¼šæ»‘é¼ æ‡¸åœæ–¼é•·æ¢åœ–å¯æŸ¥çœ‹ Mean, SD èˆ‡ P-value</span></div>
            </h3>
            <div class="h-80 w-full mb-2"><canvas id="learningChart"></canvas></div>
        </div>

        <!-- General Insights -->
        <div class="col-span-12 md:col-span-8 card p-6">
            <h3 class="text-xl font-serif text-sage-800 mb-4 border-b border-sage-100 pb-2"><i class="fa-solid fa-lightbulb mr-2 text-gold-500"></i> ç¶œåˆæ•¸æ“šæ´å¯Ÿèˆ‡ç­–ç•¥å»ºè­°</h3>
            <div id="insights-content" class="text-sm md:text-base text-sage-800 space-y-4 leading-relaxed"><!-- JS Generated --></div>
        </div>

        <!-- Satisfaction Details -->
        <div class="col-span-12 md:col-span-4 card p-6">
            <h3 class="text-xl font-serif text-sage-800 mb-4 border-b border-sage-100 pb-2"><i class="fa-regular fa-face-smile mr-2 text-sage-500"></i> æ»¿æ„åº¦ç´°é …</h3>
            <div class="grid grid-cols-1 gap-y-5" id="satisfaction-bars"><!-- JS Generated --></div>
        </div>

        <!-- PDCA -->
        <div class="col-span-12 card p-6 bg-gradient-to-br from-white to-sage-50">
            <h3 class="text-xl font-serif text-sage-800 mb-6 border-b border-sage-100 pb-2"><i class="fa-solid fa-arrows-spin mr-2 text-sage-500"></i> æ´»å‹•æˆæ•ˆ PDCA æŒçºŒæ”¹å–„å»ºè­°</h3>
            <div class="pdca-grid md:grid-cols-4 grid-cols-1">
                <div class="pdca-box pdca-plan"><h4><i class="fa-solid fa-compass-drafting"></i> Plan (è¨ˆç•«)</h4><p id="pdca-plan-text">...</p></div>
                <div class="pdca-box pdca-do"><h4><i class="fa-solid fa-play"></i> Do (åŸ·è¡Œ)</h4><p id="pdca-do-text">...</p></div>
                <div class="pdca-box pdca-check"><h4><i class="fa-solid fa-magnifying-glass-chart"></i> Check (æŸ¥æ ¸)</h4><p id="pdca-check-text">...</p></div>
                <div class="pdca-box pdca-act"><h4><i class="fa-solid fa-rocket"></i> Act (è¡Œå‹•)</h4><p id="pdca-act-text">...</p></div>
            </div>
        </div>

        <!-- Feedback -->
        <div class="col-span-12">
            <h3 class="text-2xl font-serif text-sage-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-quote-left text-sage-500"></i> å­¸å“¡æœ€æœ‰æ„Ÿæ”¶ç©«</h3>
            <div class="flex flex-wrap gap-6 justify-center md:justify-start" id="feedback-grid"></div>
        </div>

    </main>

    <footer class="w-full text-center py-10 text-sage-400 text-sm"><p>2025 å¥‡ç¾æœˆï½œé†«å­¸äººæ–‡æ²™é¾</p></footer>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwDoTNot1XRvyJLH9jktiKo5KhdR0mLv0oD-vX0JDvdTZXUHZ3u_LnlFL6fB6C-Jd-IIw/exec"; 
        
        // --- Status UI Control ---
        function setStatus(isLive) {
            const el = document.getElementById('data-status');
            if (isLive) {
                el.className = 'status-badge status-live';
                el.innerHTML = '<i class="fa-solid fa-circle-check"></i> ğŸŸ¢ å·²é€£ç·š (ä¾†è‡ª GS çœŸå¯¦è³‡æ–™)';
            } else {
                el.className = 'status-badge status-mock';
                el.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> ğŸŸ  å±•ç¤ºæ¨¡å¼ (æ¨¡æ“¬è³‡æ–™ - è«‹æª¢æŸ¥é€£ç·š)';
            }
        }

        function generateMockData() {
            // This runs ONLY if fetch fails
            const count = 43; 
            const data = [];
            const comments = ["è¬›è€…å°æ–¼é†«å­¸äººæ–‡çš„è©®é‡‹éå¸¸æ·±åˆ»ã€‚", "PBL çš„å¸¶é ˜æŠ€å·§ç¤ºç¯„å¾ˆå¯¦ç”¨ã€‚", "SDT ç†è«–èˆ‡å¯¦å‹™çš„çµåˆè®“æˆ‘å¤§é–‹çœ¼ç•Œã€‚", "éå¸¸æœ‰è³ªæ„Ÿçš„æ²™é¾ã€‚", "äº’å‹•ç’°ç¯€è¨­è¨ˆå¾—å¾ˆæ£’ã€‚", "å­¸åˆ°äº†å¦‚ä½•ç”¨æ›´æœ‰æº«åº¦çš„æ–¹å¼å»å¼•å°å­¸ç”Ÿåæ€ã€‚"];
            const roles = ["é†«å¸«", "é†«å¸«", "é†«å¸«", "è­·ç†å¸«", "è­·ç†å¸«", "å¯¦ç¿’é†«ç™‚äººå“¡", "éé†«ç™‚äººå“¡"];
            const years = ["1å¹´ä»¥ä¸‹", "1-3å¹´", "3-5å¹´", "5-10å¹´", "10å¹´ä»¥ä¸Š"];

            const randSkew = (min, max, skew) => {
                let u = 0, v = 0; while(u === 0) u = Math.random(); while(v === 0) v = Math.random();
                let num = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
                num = num / 10.0 + 0.5;
                if (num > 1 || num < 0) num = randSkew(min, max, skew);
                return Math.min(max, Math.max(min, Math.pow(num, skew) * (max - min) + min));
            }

            for (let i = 0; i < count; i++) {
                const r = roles[Math.floor(Math.random() * roles.length)];
                const baseline = randSkew(3, 5, 0.5);
                data.push({
                    role: r,
                    years: years[Math.floor(Math.random() * years.length)],
                    post_1: Math.round(baseline + (Math.random()-0.5)), 
                    post_2: Math.round(randSkew(3, 5, 0.6)),
                    post_3: Math.round(randSkew(3, 5, 0.5)), 
                    post_4: Math.round(randSkew(2.5, 5, 0.8)), 
                    post_5: Math.round(baseline),
                    post_6: Math.round(randSkew(3, 5, 0.5)),
                    post_7: Math.round(baseline + (Math.random()-0.5)*0.5), 
                    post_8: Math.round(randSkew(4, 5, 0.3)),
                    post_9: Math.round(randSkew(3, 5, 0.5)), 
                    post_10: 5, 
                    post_11: Math.round(randSkew(3.5, 5, 0.5)),
                    open_post_1: Math.random() > 0.6 ? comments[Math.floor(Math.random() * comments.length)] : "",
                    sat_1: Math.round(randSkew(4, 5, 0.2)), 
                    sat_2: 4, sat_3: 4, sat_4: 5, sat_5: 5, 
                    sat_6: Math.max(1, Math.min(10, Math.round(baseline * 2)))
                });
            }
            return data;
        }

        let chartInstances = {};

        document.addEventListener('DOMContentLoaded', () => { fetchData(); });
        function setMockMode() { setStatus(false); updateDashboard(generateMockData()); }
        async function fetchData() {
            try {
                const response = await fetch(GAS_API_URL);
                const json = await response.json();
                if (json.error) throw new Error(json.error);
                
                // If we get here, connection is successful
                setStatus(true);
                json.length === 0 ? updateDashboard([]) : updateDashboard(json);
            } catch (error) { 
                console.warn("Using Mock Data due to fetch error:", error); 
                setMockMode(); 
            }
        }

        function getMetricArray(data, key) { return data.map(d => { const val = parseFloat(d[key]); return isNaN(val) ? 3 : val; }); }
        function calculateMean(arr) { return arr.length === 0 ? 0 : arr.reduce((a, b) => a + b, 0) / arr.length; }
        function calculateCronbachAlpha(data, itemKeys) {
            const N = itemKeys.length;
            const itemVariances = itemKeys.map(key => {
                const values = getMetricArray(data, key);
                const mean = calculateMean(values);
                return values.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / values.length;
            });
            const sumItemVariance = itemVariances.reduce((a, b) => a + b, 0);
            const totalScores = data.map(d => itemKeys.reduce((acc, key) => acc + (parseFloat(d[key]) || 0), 0));
            const totalMean = calculateMean(totalScores);
            const totalVariance = totalScores.reduce((acc, val) => acc + Math.pow(val - totalMean, 2), 0) / totalScores.length;
            return totalVariance === 0 ? 0 : (N / (N - 1)) * (1 - (sumItemVariance / totalVariance));
        }
        function tTestOneSample(values, mu) {
            const mean = jStat.mean(values); const sd = jStat.stdev(values, true); const n = values.length;
            const se = sd / Math.sqrt(n); const t = (mean - mu) / se; const df = n - 1;
            const p = 1 - jStat.studentt.cdf(t, df); 
            return { t: t, p: p, mean: mean, sd: sd, n: n };
        }
        function calculateCorrelation(x, y) { return jStat.corrcoeff(x, y); }

        function updateDashboard(data) {
            const count = data.length; document.getElementById('total-responses').innerText = count; if (count === 0) return;
            document.getElementById('avg-satisfaction').innerText = calculateMean(getMetricArray(data, 'sat_1')).toFixed(1);
            document.getElementById('avg-recommend').innerText = calculateMean(getMetricArray(data, 'sat_6')).toFixed(1);

            const learningKeys = ['post_1', 'post_2', 'post_3', 'post_4', 'post_5', 'post_6', 'post_7', 'post_8', 'post_9', 'post_10', 'post_11'];
            const alpha = calculateCronbachAlpha(data, learningKeys);
            document.getElementById('cronbach-alpha').innerText = alpha.toFixed(2);
            document.getElementById('alpha-interpretation').innerText = alpha > 0.9 ? "ä¿¡åº¦æ¥µä½³ (Excellent)" : alpha > 0.8 ? "ä¿¡åº¦è‰¯å¥½ (Good)" : "ä¿¡åº¦å¯æ¥å—";

            updateDemographics(data);
            const learningStats = updateLearningAnalysis(data, learningKeys);
            updateSatBars(data);
            updateStickyNotes(data);
            updateGroupInsights(data, learningKeys);
            
            const drivers = updateKeyDriverAnalysis(data);
            const sdtScores = updateSDTChart(data);

            generateDetailedInsights(drivers, sdtScores);
            generateInsightsAndPDCA(learningStats, alpha, count, drivers);
        }

        function updateKeyDriverAnalysis(data) {
            const target = getMetricArray(data, 'sat_6'); 
            const factors = [
                { k: 'post_1', l: 'äººæ–‡ç†è§£' }, { k: 'post_2', l: 'PBLæŠ€å·§' },
                { k: 'post_5', l: 'SDTç†è§£' }, { k: 'sat_2', l: 'è¬›è€…å‘ˆç¾' }, { k: 'sat_4', l: 'åæ€ç©ºé–“' }
            ];
            const correlations = factors.map(f => {
                const vals = getMetricArray(data, f.k);
                const r = calculateCorrelation(vals, target);
                return { label: f.l, r: r || 0 };
            }).sort((a, b) => b.r - a.r);

            const ctx = document.getElementById('driverChart').getContext('2d');
            if (chartInstances.driver) chartInstances.driver.destroy();
            chartInstances.driver = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: correlations.map(c => c.label),
                    datasets: [{
                        label: 'ç›¸é—œä¿‚æ•¸ (r)',
                        data: correlations.map(c => c.r),
                        backgroundColor: correlations.map(c => c.r > 0.7 ? '#fbbf24' : '#9bb69b'),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    scales: { x: { min: 0, max: 1 } }, plugins: { legend: { display: false } }
                }
            });
            return correlations;
        }

        function updateSDTChart(data) {
            const compVals = [...getMetricArray(data, 'post_2'), ...getMetricArray(data, 'post_7')];
            const relVals = getMetricArray(data, 'post_8');
            const autoVals = getMetricArray(data, 'post_6');
            const scores = [calculateMean(compVals), calculateMean(relVals), calculateMean(autoVals)];
            
            const ctx = document.getElementById('sdtChart').getContext('2d');
            if (chartInstances.sdt) chartInstances.sdt.destroy();
            chartInstances.sdt = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['å‹ä»»æ„Ÿ (Competence)', 'é—œä¿‚æ„Ÿ (Relatedness)', 'è‡ªä¸»æ„Ÿ (Autonomy)'],
                    datasets: [{
                        label: 'å¹³å‡å¾—åˆ†', data: scores,
                        backgroundColor: 'rgba(116, 148, 116, 0.4)', borderColor: '#567656',
                        pointBackgroundColor: '#fbbf24', pointBorderColor: '#fff',
                    }]
                },
                options: {
                    scales: { 
                        r: { 
                            min: 2, max: 5, ticks: { display: false },
                            pointLabels: {
                                font: { size: 12, family: '"Noto Serif TC", serif' },
                                color: '#2d3d2d'
                            }
                        } 
                    },
                    layout: { padding: 20 },
                    plugins: { legend: { display: false } }
                }
            });
            return { comp: scores[0], rel: scores[1], auto: scores[2] };
        }

        function generateDetailedInsights(drivers, sdt) {
            const container = document.getElementById('driver-sdt-insights');
            const topDriver = drivers[0];
            
            const sdtArr = [{ l: 'å‹ä»»æ„Ÿ', v: sdt.comp }, { l: 'é—œä¿‚æ„Ÿ', v: sdt.rel }, { l: 'è‡ªä¸»æ„Ÿ', v: sdt.auto }];
            sdtArr.sort((a,b) => b.v - a.v);
            const highSDT = sdtArr[0]; const lowSDT = sdtArr[2];

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-sage-900 mb-2 border-b border-sage-200 pb-1">é©…å‹•å› å­è§£è®€</h4>
                        <p>åˆ†æé¡¯ç¤ºã€Œ<strong>${topDriver.label}</strong>ã€èˆ‡å­¸å“¡çš„æ¨è–¦æ„é¡˜(NPS)ç›¸é—œæ€§æœ€å¼· (r=${topDriver.r.toFixed(2)})ã€‚</p>
                        <p class="mt-2 text-sage-600">
                            <i class="fa-solid fa-arrow-right text-gold-500 mr-1"></i>
                            <strong>æ´å¯Ÿï¼š</strong>é€™ä»£è¡¨å­¸å“¡æœ€åœ¨ä¹çš„æ˜¯"${topDriver.label}"çš„å“è³ªã€‚è‹¥ä¸‹ä¸€æœŸæƒ³æé«˜å£ç¢‘ï¼Œæ‡‰å„ªå…ˆå°‡è³‡æºæŠ•å…¥å„ªåŒ–æ­¤é …ç›®ã€‚
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-sage-900 mb-2 border-b border-sage-200 pb-1">å¿ƒç†éœ€æ±‚è§£è®€</h4>
                        <p>å­¸å“¡åœ¨ã€Œ<strong>${highSDT.l}</strong>ã€å¾—åˆ†æœ€é«˜ (${highSDT.v.toFixed(2)})ï¼Œè€Œåœ¨ã€Œ<strong>${lowSDT.l}</strong>ã€ç›¸å°è¼ƒä½ã€‚</p>
                        <p class="mt-2 text-sage-600">
                            <i class="fa-solid fa-arrow-right text-gold-500 mr-1"></i>
                            <strong>æ´å¯Ÿï¼š</strong>èª²ç¨‹æˆåŠŸå»ºç«‹äº†å­¸å“¡çš„${highSDT.l}ï¼Œä½†${lowSDT.l}ç¨å¼±ã€‚å»ºè­°è¨­è¨ˆæ›´å¤š${lowSDT.l === 'é—œä¿‚æ„Ÿ' ? 'å°çµ„äº¤æµ' : lowSDT.l === 'è‡ªä¸»æ„Ÿ' ? 'é–‹æ”¾å¼æ¢ç´¢' : 'å¯¦ä½œæ¼”ç·´'}ï¼Œä»¥é”æˆå‹•æ©Ÿå¹³è¡¡ã€‚
                        </p>
                    </div>
                </div>
            `;
        }

        function updateDemographics(data) {
            const roleCounts = {};
            data.forEach(d => { const r = d.role || "æœªå¡«å¯«"; roleCounts[r] = (roleCounts[r] || 0) + 1; });
            const ctxRole = document.getElementById('roleChart').getContext('2d');
            if (chartInstances.role) chartInstances.role.destroy();
            chartInstances.role = new Chart(ctxRole, {
                type: 'doughnut',
                data: { labels: Object.keys(roleCounts), datasets: [{ data: Object.values(roleCounts), backgroundColor: ['#749474', '#9bb69b', '#c5d6c5', '#e3ebe3', '#567656'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
            });

            const yearCounts = {};
            data.forEach(d => { const y = d.years || "æœªå¡«å¯«"; yearCounts[y] = (yearCounts[y] || 0) + 1; });
            const ctxYears = document.getElementById('yearsChart').getContext('2d');
            if (chartInstances.years) chartInstances.years.destroy();
            chartInstances.years = new Chart(ctxYears, {
                type: 'bar',
                data: { labels: Object.keys(yearCounts), datasets: [{ label: 'äººæ•¸', data: Object.values(yearCounts), backgroundColor: '#9bb69b', borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        function updateLearningAnalysis(data, keys) {
            const rawLabels = ['é†«å­¸äººæ–‡ç†è§£', 'PBLæŠ€å·§', 'åæ€å¼•å°', 'Kolbé‹ç”¨', 'SDTç†è§£', 'æ•™å­¸è‡ªä¸»æ€§', 'å‹ä»»æ„Ÿ', 'é—œä¿‚æ„Ÿ', 'ç²å¾—å…·é«”ç¶“é©—', 'ä»¥å­¸ç”Ÿç‚ºä¸­å¿ƒ', 'æ”¹å–„æ•™å­¸æ–‡åŒ–'];
            let statsData = keys.map((key, index) => {
                const values = getMetricArray(data, key);
                const stats = tTestOneSample(values, 3.0);
                return { label: rawLabels[index], key: key, ...stats };
            });
            statsData.sort((a, b) => b.mean - a.mean);
            
            const ctx = document.getElementById('learningChart').getContext('2d');
            if (chartInstances.learning) chartInstances.learning.destroy();
            chartInstances.learning = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: statsData.map(d => d.label),
                    datasets: [{
                        label: 'Post-test Mean', data: statsData.map(d => d.mean), stats: statsData,
                        backgroundColor: statsData.map((v, i) => i === 0 ? '#f59e0b' : '#60a5fa'), borderRadius: 6, barThickness: 25
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { min: 2, max: 5, grid: { color: '#f0f0f0' } }, x: { grid: { display: false } } },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            enabled: true, backgroundColor: 'rgba(23, 37, 84, 0.95)', titleColor: '#fbbf24', bodyColor: '#fff',
                            callbacks: { label: (context) => { const stat = context.dataset.stats[context.dataIndex]; return [`Post-test: ${stat.mean.toFixed(2)} Â± ${stat.sd.toFixed(2)}`, `N: ${stat.n}`, `P-value: ${stat.p < 0.001 ? '< .001 ***' : stat.p.toFixed(3)}`]; } }
                        }
                    }
                }
            });
            return statsData;
        }

        function updateSatBars(data) {
            const container = document.getElementById('satisfaction-bars'); container.innerHTML = '';
            [{ l: 'è¬›è€…å‘ˆç¾', k: 'sat_2' }, { l: 'æ™‚é–“å®‰æ’', k: 'sat_3' }, { l: 'åæ€ç©ºé–“', k: 'sat_4' }, { l: 'ç¬¦åˆæœŸå¾…', k: 'sat_5' }].forEach(m => {
                const avg = calculateMean(getMetricArray(data, m.k)).toFixed(1);
                container.insertAdjacentHTML('beforeend', `<div><div class="flex justify-between mb-1"><span class="text-sm font-medium text-sage-700">${m.l}</span><span class="text-sm font-bold text-sage-600">${avg}</span></div><div class="w-full bg-sage-100 rounded-full h-2"><div class="bg-sage-500 h-2 rounded-full" style="width: ${(avg/5)*100}%"></div></div></div>`);
            });
        }
        function updateStickyNotes(data) {
            const container = document.getElementById('feedback-grid'); container.innerHTML = '';
            const comments = data.map(d => d.open_post_1).filter(c => c && c.toString().trim() !== "").reverse();
            if (comments.length === 0) { container.innerHTML = '<p class="text-sage-400 w-full text-center">å°šç„¡æ–‡å­—å›é¥‹</p>'; return; }
            comments.slice(0, 8).forEach((c, i) => { container.insertAdjacentHTML('beforeend', `<div class="sticky-note note-color-${(i % 4) + 1} p-5 rounded-sm w-full md:w-64 min-h-[160px] flex flex-col relative"><i class="fa-solid fa-thumbtack text-sage-800/20 absolute top-2 left-1/2 -translate-x-1/2"></i><div class="mt-4 flex-grow flex items-center justify-center text-center"><p class="text-sage-900 text-sm font-serif leading-relaxed">"${c}"</p></div></div>`); });
        }
        function updateGroupInsights(data, itemKeys) {
            const getGroupAvg = (groupKey) => {
                const groups = {}; data.forEach(d => { const g = d[groupKey] || 'æœªå¡«å¯«'; if (!groups[g]) groups[g] = { sum: 0, count: 0 }; const userAvg = itemKeys.reduce((acc, k) => acc + (parseFloat(d[k])||3), 0) / itemKeys.length; groups[g].sum += userAvg; groups[g].count++; });
                return Object.entries(groups).map(([name, obj]) => ({ name, mean: obj.sum / obj.count })).sort((a,b) => b.mean - a.mean);
            };
            const roleStats = getGroupAvg('role'); if(roleStats.length > 0) document.getElementById('role-insights').innerHTML = `<p><span class="font-bold text-sage-900">${roleStats[0].name}</span> ç¾¤é«”å±•ç¾æœ€é«˜å­¸ç¿’æŠ•å…¥åº¦ (Avg: ${roleStats[0].mean.toFixed(2)})ã€‚</p>`;
            const yearStats = getGroupAvg('years'); if(yearStats.length > 0) document.getElementById('year-insights').innerHTML = `<p><span class="font-bold text-sage-900">${yearStats[0].name}</span> è³‡æ­·å­¸å“¡ç²ç›Šæœ€å¤š (Avg: ${yearStats[0].mean.toFixed(2)})ã€‚</p>`;
        }
        function generateInsightsAndPDCA(stats, alpha, n, drivers) {
            const topItem = stats[0]; const bottomItem = stats[stats.length - 1]; const topDriver = drivers[0];
            const insightsContainer = document.getElementById('insights-content');
            let insightHTML = `<p><strong><i class="fa-solid fa-check-circle text-sage-500"></i> æˆæ•ˆç¸½çµï¼š</strong> N=${n}ï¼Œä¿¡åº¦ Î±=${alpha.toFixed(2)}ã€‚å­¸ç¿’æŒ‡æ¨™å¹³å‡æ•¸çš†é¡¯è‘—é«˜æ–¼ä¸­ç«‹å€¼ã€‚</p><p class="mt-2"><strong><i class="fa-solid fa-key text-gold-500"></i> é—œéµé©…å‹•å› å­ï¼š</strong> åˆ†æé¡¯ç¤ºã€Œ<span class="font-bold border-b border-gold-400">${topDriver.label}</span>ã€èˆ‡æ¨è–¦æ„é¡˜(NPS)ç›¸é—œæ€§æœ€é«˜ (r=${topDriver.r.toFixed(2)})ã€‚é€™æ„å‘³è‘—æå‡æ­¤é …ç›®çš„è¡¨ç¾å°‡æœ€ç›´æ¥å¸¶å‹•å£ç¢‘å‚³æ’­ã€‚</p>`;
            insightsContainer.innerHTML = insightHTML;
            document.getElementById('pdca-plan-text').innerText = `é‡å°é©…å‹•å› å­ã€Œ${topDriver.label}ã€åˆ¶å®šå¼·åŒ–ç­–ç•¥ï¼Œä¸¦æ”¹å–„è¼ƒå¼±çš„ã€Œ${bottomItem.label}ã€ã€‚`;
            document.getElementById('pdca-do-text').innerText = `åœ¨æ´»å‹•ä¸­å¢åŠ é‡å°ã€Œ${topDriver.label}ã€çš„å°ˆé–€ç’°ç¯€ï¼Œä¸¦æä¾›ã€Œ${bottomItem.label}ã€çš„è¼”åŠ©å·¥å…·ã€‚`;
            document.getElementById('pdca-check-text').innerText = `æŒçºŒç›£æ¸¬ NPS èˆ‡ã€Œ${topDriver.label}ã€çš„ç›¸é—œä¿‚æ•¸ï¼Œé©—è­‰ç­–ç•¥æœ‰æ•ˆæ€§ã€‚`;
            document.getElementById('pdca-act-text').innerText = `å°‡ã€Œ${topItem.label}ã€èˆ‡é«˜é©…å‹•å› å­çš„æˆåŠŸè¦ç´ æ¨™æº–åŒ–ï¼Œæ¨å»£è‡³å…¨é™¢æ•™å­¸æ´»å‹•ã€‚`;
        }
    </script>
</body>
</html>
